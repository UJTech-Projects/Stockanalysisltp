name: Scheduled Jobs

on:
  schedule:
    # Token refresh every 6 hours
    - cron: '0 */6 * * *'
    # Fetch LTP â€” run once daily after market close (approx 16:30 IST -> UTC convert appropriately)
    - cron: '30 11 * * *' # This is 16:00 IST in UTC during non-DST; adjust as necessary

jobs:
  refresh-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: npm ci

      - name: Run refresh-token script
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ANGEL_API_KEY: ${{ secrets.ANGEL_API_KEY }}
          ANGEL_CLIENT_CODE: ${{ secrets.ANGEL_CLIENT_CODE }}
          ANGEL_CLIENT_PASSWORD: ${{ secrets.ANGEL_CLIENT_PASSWORD }}
          ANGEL_TOTP_SECRET: ${{ secrets.ANGEL_TOTP_SECRET }}
        run: node scripts/refreshToken.js

  fetch-ltp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: npm ci

      - name: Run fetch-ltp script
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ANGEL_API_KEY: ${{ secrets.ANGEL_API_KEY }}
        run: node scripts/fetchLTP.js
